<nb-card class="ptc-card" [nbSpinner]="loading" >
  <nb-card-body >
    <form [formGroup]="form">
      <!-- ROW 1-->
      <div class="row">

        <!-- 企業別 -->
        <div class="col-sm-3 input-group">
          <label for="NodeID" class="col-sm-4 col-form-label"
            starsign>{{ translations.STORE.BU_NAME | translate }}</label>
          <div class="col-sm-8">
            <app-bu-select validator formControlName="NodeID" [(ngModel)]="model.NodeID"
              [placeholder]="translations.COMMON.SELECT_PLACEHOLDER | translate : {key: ''}" disabled>
            </app-bu-select>
          </div>
        </div>
        <!-- 進線時間 -->
        <div class="col-sm-3 input-group">
          <label class="col-sm-4 col-form-label"
            starsign>{{ translations.CASE_COMMON.IN_LINE_TIME | translate }}</label>
          <div class="col-sm-8 col-form-label">
            {{model.IncomingDateTime | datetime}}
          </div>
        </div>
        <!-- 來源編號 -->
        <div class="col-sm-3 input-group">
          <label class="col-sm-4 col-form-label">{{ translations.CASE_COMMON.CASE_SOURCE_ID | translate }}</label>
          <div class="col-sm-8 col-form-label">
            {{model.SourceID}}
          </div>
        </div>
      </div>
      <!-- END ROW 1-->


      <!-- ROW 2-->
      <div class="row">

        <!-- 執行單位 -->
        <div class="col-sm-3 input-group">
          <label for="GroupID" class="col-sm-4 col-form-label"
            starsign>{{ translations.CASE_COMMON.EXECUTE_UNIT | translate }}</label>
          <div class="col-sm-8">
            <app-group-select type="text" validator formControlName="GroupID" [(ngModel)]="model.GroupID"
              [isSelf]="true" [defaultFirst]="false"
              [placeholder]="translations.COMMON.SELECT_PLACEHOLDER | translate : {key: ''}" disabled #groupSelect>
            </app-group-select>
          </div>
        </div>
        <!-- 預立案單位名稱 -->
        <div class="col-sm-3 input-group">
          <label
            class="col-sm-4 col-form-label">{{ translations.CASE_COMMON.DEFAULT_CASE_UNIT_NAME | translate }}</label>
          <div class="col-sm-8 col-form-label">
            {{model.RelationNodeName}}
          </div>
        </div>
        <!-- 預立案勾稽案件編號 -->
        <div class="col-sm-3 input-group">
          <label class="col-sm-4 col-form-label">{{ translations.CASE_COMMON.DEFAULT_CASE_ID | translate }}</label>
          <div class="col-sm-8 col-form-label">
            <nb-card class="m-3 p-3 prevention-case-card" *ngIf="model.RelationCaseSourceID ? true : false">
              <span>{{model.RelationCaseSourceID}} <i class="nb-close-circled small-close text-right" stop-propagation
                  (click)="btnRemoveSource()"></i></span>
            </nb-card>
          </div>
        </div>
        <!-- 預立案 -->
        <div class="col-sm-3 input-group">
          <label class="col-sm-4 col-form-label">{{ translations.CASE_COMMON.DEFAULT_CASE | translate }}</label>
          <div class="col-sm-8">
            <button type="button" class="btn btn-sm btn-ptc-save"
              (click)="btnPreventionCase()">{{ translations.COMMON.VIEW | translate }}</button>
          </div>
        </div>
      </div>
      <!-- END ROW 2-->

      <!-- ROW 3-->
      <div class="row">
        <!-- 來源資訊 -->
        <div class="col-sm-3 input-group">
          <label for="CaseSourceType" class="col-sm-4 col-form-label"
            starsign>{{ translations.CASE_COMMON.SOURCE_INFO | translate }}</label>
          <div class="col-sm-8">
            <app-case-source-select [buID]="model.NodeID" validator
              [attr.readonly]="uiActionType == actionType.Read ? true : null"
              [placeholder]="translations.COMMON.SELECT_PLACEHOLDER | translate : {key: ''}"
              formControlName="CaseSourceType" [(ngModel)]="model.CaseSourceType" disabled>
            </app-case-source-select>
          </div>
        </div>
        <!-- 預立案 -->
        <div class="col-sm-2 input-group">
          <label for="IsPrevention"
            class="col-sm-6 col-form-label">{{ translations.CASE_COMMON.DEFAULT_CASE | translate }}</label>
          <nb-checkbox validator [disabled]="(uiActionType == actionType.Read) ? true : null" class="col-sm-6"
            formControlName="IsPrevention" id="IsPrevention" [(ngModel)]="model.IsPrevention">
          </nb-checkbox>
        </div>
        <!-- END 預立案 -->
        <!-- 二次來電 -->
        <div class="col-sm-2 input-group">
          <label for="IsTwiceCall"
            class="col-sm-6 col-form-label">{{ translations.CASE_COMMON.TWICE_CALLING | translate }}</label>
          <nb-checkbox validator [disabled]="(uiActionType == actionType.Read) ? true : null" class="col-sm-6"
            formControlName="IsTwiceCall" id="IsTwiceCall" [(ngModel)]="model.IsTwiceCall">
          </nb-checkbox>
        </div>
        <!-- END 二次來電 -->
        <!-- 錄音編號 -->
        <div class="col-sm-2 input-group">
          <label class="col-sm-6 col-form-label">{{ translations.CASE_COMMON.RECORD_ID | translate }}</label>
          <div class="col-sm-6 col-form-label">
            {{model.VoiceID}}
          </div>
        </div>
        <!-- 錄音讀取 -->
        <div class="col-sm-2 input-group">
          <label class="col-sm-6 col-form-label">{{ translations.CASE_COMMON.RECORD_READ | translate }}</label>
          <div class="col-sm-6 col-form-label">
            <i class="nb-volume-high" id="voice"></i>
          </div>
        </div>
      </div>
      <!-- END ROW 3-->

      <!-- ROW 4-->
      <div class="row">
        <div class="col-sm-6 input-group">
          <!--客服備註 -->
          <label class="col-sm-2 col-form-label">{{ translations.CASE_COMMON.CC_MEMO | translate }}</label>
          <div class="col-sm-10">
            <div class="row">
              <textarea rows="4" type="text" class="form-control" [ngModelOptions]="{standalone: true}"
                [attr.readonly]="uiActionType == actionType.Read ? true : null" [(ngModel)]="model.Remark"></textarea>
            </div>
          </div>
        </div>
        <!-- 勾稽案件編號 -->
        <div class="col-sm-6 input-group">
          <label class="col-sm-2 col-form-label">{{ translations.CASE_COMMON.RELATED_CASE_ID | translate }}</label>
          <div class="col-sm-4">
            <input type="text" class="form-control" [attr.readonly]="uiActionType == actionType.Read ? true : null"
              [placeholder]="translations.CASE_COMMON.PLEASE_ENTER | translate" [ngModelOptions]="{standalone: true}"
              [(ngModel)]="checkableCaseID" (keyup.enter)="btnCheckCase()">
          </div>
          <div class="col-sm-12">
            <div class="row">
              <nb-card class="m-3 p-3 prevention-case-card" *ngFor="let relationCaseID of model.RelationCaseIDs"
                (click)="btnPreviewCase(relationCaseID)">
                <span>{{relationCaseID}} <i class="nb-close-circled small-close text-right" stop-propagation
                    (click)="btnRemovePreviewCase(relationCaseID)"></i></span>
              </nb-card>
            </div>
          </div>
        </div>
      </div>
      <!-- ROW 4-->

      <!-- ROW 5-->
      <div class="row">
        <!-- 來源人 -->
        <div class="col-sm-6 input-group">
          <nb-accordion class="ptc-accordion-only-header">
            <nb-accordion-item [collapsed]="false">
              <!-- 反應人資訊 -->
              <nb-accordion-item-header class="accordionHeaderBlue">
                {{ translations.CASE_COMMON.RESPONDER_INFO | translate }}</nb-accordion-item-header>
              <nb-accordion-item-body>
                <app-us [form]="usform" [uiActionType]="uiActionType" [(user)]="model.User" [sourcekey]="model.key"
                  [organizationSearchTerm]="{NotIncludeDefKey: [definitionKey.STORE], IsEnabled: true}" #us>
                </app-us>
              </nb-accordion-item-body>
            </nb-accordion-item>
          </nb-accordion>

        </div>
        <!-- END 來源人 -->
        <!-- 勾稽案件清單 -->
        <div class="col-sm-6 input-group">
          <nb-accordion class="ptc-accordion-only-header">
            <nb-accordion-item [collapsed]="false">
              <!-- 相關案件 -->
              <nb-accordion-item-header class="accordionHeaderBlue">
                {{ translations.CASE_COMMON.RELATE_CASE | translate }}</nb-accordion-item-header>
              <nb-accordion-item-body>
                <div style="cursor: pointer;" class="text-right" (click)="btnRefresh()"><i
                    class="nb-search"></i>{{ translations.COMMON.BTN_SEARCH | translate }}
                </div>
                <app-ac (related)="btnRelatedCase($event)" (lookup)="btnLookupCase($event)" [sourcekey]="model.key" #ac>
                </app-ac>
              </nb-accordion-item-body>
            </nb-accordion-item>
          </nb-accordion>

        </div>
        <!-- END 勾稽案件清單 -->
      </div>
      <!-- END ROW 5-->


      <!-- ROW 7-->
      <div class="row flex-center">
        <button *ngIf="uiActionType !== actionType.Read" type="button" class="btn btn-md btn-ptc-save"
          (click)="btnSaveCaseSource()">{{ translations.COMMON.BTN_SAVE | translate }}</button>
      </div>
      <!-- END ROW 7-->
    </form>
  </nb-card-body>
</nb-card>

<nb-card class="mt-3" [nbSpinner]="subLoading">
  <nb-card-body class="p-0">
    <button type="button" *ngIf="uiActionType !== actionType.Read" class="btn btn-sm btn-ptc-create float-right mt-1 mr-2"
      (click)="btnCreateCase()" stop-propagation>{{ translations.COMMON.BTN_ADD | translate }}</button>
    <nb-tabset #tabs *ngIf="caseKeyPairs.length > 0">
      <nb-tab class="p-0" tabTitle="{{item.id}}" *ngFor="let item of caseKeyPairs" lazyLoad style="overflow-x: hidden;">
        <!-- <div class="float-right" id="icon-group" (click)="closeCase(model.key, item.key)">
          <i class="nb-close"></i>
        </div> -->
        <app-cc2 [uiActionType]="uiActionType" *ngIf="isNew(item.id) === false" [caseKey]="item.key"
          [sourcekey]="model.key" (closeTab)="closeCase($event)"></app-cc2>
        <app-cc3 *ngIf="isNew(item.id)" [caseKey]="item.key" [sourcekey]="model.key"></app-cc3>
      </nb-tab>
    </nb-tabset>
  </nb-card-body>
</nb-card>
