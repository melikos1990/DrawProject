<nb-card class="ptc-card">
  <nb-card-body>
    <form [formGroup]="form">

      <!-- ROW 1-->
      <div class="row">

        <!-- 企業別 -->
        <div class="col-sm-3 input-group">
          <label for="NodeID" class="col-sm-4 col-form-label"
            starsign>{{ translations.NODE_DEFINITION.BU | translate }}</label>
          <div class="col-sm-8">
            <app-bu-select type="text" [isSelf]="true" validator formControlName="NodeID"
              (onSelectedChange)="onBUSelectChange()" (ngModelChange)="onBUChange($event)" [(ngModel)]="model.NodeID"
              [IsSearchEnabled]="IsSearchEnabled"
              [placeholder]="translations.COMMON.SELECT_PLACEHOLDER | translate : {key: ''}">
            </app-bu-select>
          </div>
        </div>
        <!-- 進線時間 -->
        <div class="col-sm-3 input-group">
          <label class="col-sm-4 col-form-label"
            starsign>{{ translations.CASE_COMMON.IN_LINE_TIME | translate }}</label>
          <div class="col-sm-8">
            <div class="col-sm-12 col-form-label">
              {{model.IncomingDateTime | datetime}}
            </div>
          </div>
        </div>
        <!-- 錄音編號 -->
        <div class="col-sm-3 input-group">
          <label class="col-sm-4 col-form-label">{{ translations.CASE_COMMON.RECORD_ID | translate }}</label>
          <div class="col-sm-12 col-form-label">

          </div>
        </div>
      </div>
      <!-- END ROW 1-->

      <!-- ROW 2-->
      <div class="row">
        <!-- 執行單位 -->
        <div class="col-sm-3 input-group">
          <label for="GroupID" class="col-sm-4 col-form-label"
            starsign>{{ translations.CASE_COMMON.EXECUTE_UNIT | translate }}</label>
          <div class="col-sm-8">
            <app-group-select type="text" validator formControlName="GroupID" (ngModelChange)="onGroupChange($event)"
              [(ngModel)]="model.GroupID" [isSelf]="true"
              [placeholder]="translations.COMMON.SELECT_PLACEHOLDER | translate : {key: ''}" #groupSelect>
            </app-group-select>
          </div>
        </div>
        <!-- 預立案單位名稱 -->
        <div class="col-sm-3 input-group">
          <label
            class="col-sm-4 col-form-label">{{ translations.CASE_COMMON.DEFAULT_CASE_UNIT_NAME | translate }}</label>
          <div class="col-sm-8 col-form-label">
            {{model.RelationNodeName}}
          </div>
        </div>
        <!-- 預立案勾稽案件編號 -->
        <div class="col-sm-3 input-group">
          <label class="col-sm-4 col-form-label">{{ translations.CASE_COMMON.DEFAULT_CASE_ID | translate }}</label>
          <div class="col-sm-8 col-form-label">
            <nb-card class="m-3 p-3 prevention-case-card" *ngIf="model.RelationCaseSourceID ? true : false">
              <span>{{model.RelationCaseSourceID}} <i class="nb-close-circled small-close text-right" stop-propagation
                  (click)="btnRemoveSource()"></i></span>
            </nb-card>
          </div>
        </div>
        <!-- 預立案 -->
        <div class="col-sm-3 input-group">
          <label class="col-sm-4 col-form-label">{{ translations.CASE_COMMON.DEFAULT_CASE | translate }}</label>
          <div class="col-sm-8">
            <button type="button" class="btn btn-sm btn-ptc-save"
              (click)="btnPreventionCase()">{{ translations.COMMON.VIEW | translate }}</button>
          </div>
        </div>
      </div>
      <!-- END ROW 2-->

      <!-- ROW 3-->
      <div class="row">
        <!-- 來源資訊 -->
        <div class="col-sm-3 input-group">
          <label for="CaseSourceType" class="col-sm-4 col-form-label"
            starsign>{{ translations.CASE_COMMON.SOURCE_INFO | translate }}</label>
          <div class="col-sm-8">
            <app-case-source-select [buID]="model.NodeID" validator
              [placeholder]="translations.COMMON.SELECT_PLACEHOLDER | translate : {key: ''}"
              formControlName="CaseSourceType" [(ngModel)]="model.CaseSourceType" #caseSource>
            </app-case-source-select>
          </div>
        </div>
        <!-- 預立案 -->
        <div class="col-sm-3 input-group">
          <label for="IsPrevention"
            class="col-sm-4 col-form-label">{{ translations.CASE_COMMON.DEFAULT_CASE | translate }}</label>
          <nb-checkbox validator class="col-sm-8" formControlName="IsPrevention" id="IsPrevention"
            (change)="onCheckChange()" [(ngModel)]="model.IsPrevention">
          </nb-checkbox>
        </div>
        <!-- END 預立案 -->
        <!-- 二次來電 -->
        <div class="col-sm-3 input-group">
          <label for="IsTwiceCall"
            class="col-sm-4 col-form-label">{{ translations.CASE_COMMON.TWICE_CALLING | translate }}</label>
          <nb-checkbox validator class="col-sm-8" formControlName="IsTwiceCall" id="IsTwiceCall"
            (change)="onCheckChange()" [(ngModel)]="model.IsTwiceCall">
          </nb-checkbox>
        </div>
        <!-- END 二次來電 -->
      </div>
      <!-- END ROW 3-->

      <!-- ROW 4-->
      <div class="row">
        <!-- 客服備註 -->
        <div class="col-sm-6 input-group">
          <label class="col-sm-2 col-form-label">{{ translations.CASE_COMMON.CC_MEMO | translate }}</label>
          <div class="col-sm-10">
            <div class="row">
              <textarea rows="4" type="text" class="form-control" [ngModelOptions]="{standalone: true}"
                [attr.readonly]="uiActionType == actionType.Read ? true : null" [(ngModel)]="model.Remark"></textarea>
            </div>
          </div>
        </div>
        <!-- 勾稽案件編號 -->
        <div class="col-sm-6 input-group">
          <label class="col-sm-2 col-form-label">{{ translations.CASE_COMMON.RELATED_CASE_ID | translate }}</label>
           <div class="col-sm-4">
            <input type="text" class="form-control"
              [placeholder]="translations.CASE_COMMON.PLEASE_ENTER | translate" [ngModelOptions]="{standalone: true}"
              [(ngModel)]="checkableCaseID" (keyup.enter)="btnCheckCase()">
           </div>
          <div class="col-sm-12">
            <div class="row">
              <nb-card class="m-3 p-3 prevention-case-card" *ngFor="let relationCaseID of model.RelationCaseIDs"
                (click)="btnPreviewCase(relationCaseID)">
                <span>{{relationCaseID}} <i class="nb-close-circled small-close text-right" stop-propagation
                    (click)="btnRemovePreviewCase(relationCaseID)"></i></span>
              </nb-card>
            </div>
          </div>
        </div>
      </div>
      <!-- ROW 4-->

      <!-- ROW 5-->
      <div class="row">
        <!-- 來源人 -->
        <div class="col-sm-6 input-group">
          <nb-accordion>
            <nb-accordion-item [collapsed]="false">
              <nb-accordion-item-header class="accordionHeaderBlue">
                {{ translations.CASE_COMMON.RESPONDER_INFO | translate }}</nb-accordion-item-header>
              <nb-accordion-item-body>
                <app-us [form]="usform" [(user)]="model.User" [sourcekey]="model.key"
                  [organizationSearchTerm]="{NotIncludeDefKey: [definitionKey.STORE], IsEnabled: true}" #us></app-us>
              </nb-accordion-item-body>
            </nb-accordion-item>
          </nb-accordion>

        </div>
        <!-- END 來源人 -->
        <!-- 勾稽案件清單 -->
        <div class="col-sm-6 input-group">
          <nb-accordion>
            <nb-accordion-item [collapsed]="false">
              <nb-accordion-item-header class="accordionHeaderBlue">
                {{ translations.CASE_COMMON.RELATE_CASE | translate }}
              </nb-accordion-item-header>
              <nb-accordion-item-body>
                <div style="cursor: pointer;" class="text-right" (click)="btnRefresh()"><i
                    class="nb-search"></i>{{ translations.COMMON.BTN_SEARCH | translate }}</div>
                <app-ac (related)="btnRelatedCase($event)" (lookup)="btnLookupCase($event)" [sourcekey]="model.key" #ac>
                </app-ac>
              </nb-accordion-item-body>
            </nb-accordion-item>
          </nb-accordion>

        </div>
        <!-- END 勾稽案件清單 -->
      </div>
      <!-- END ROW 5-->



      <!-- ROW 7-->
      <div class="row flex-center">
        <button type="button" class="btn btn-sm btn-ptc-save" *ngIf="isOnlySourceUpdate"
          (click)="btnSaveCaseSource()">{{ translations.CASE_NOTICE.CASE_SAVE | translate }}</button>
      </div>
      <!-- END ROW 7-->

    </form>
  </nb-card-body>
</nb-card>

<div *ngIf="!isOnlySourceUpdate">
  <div class="mt-3">
    <!-- 案件區塊 -->
    <app-cc1 [form]="subform" [(model)]="model?.Cases[0]" [sourcekey]="model.key" #cc1></app-cc1>
    <!-- END 案件區塊 -->
  </div>

  <div class="row flex-center">
    <button class="btn btn-md btn-ptc-confirm m-3"
      (click)="btnSaveCaseSourceComplete()">{{ translations.CASE_COMMON.CREATE_CASE | translate }}</button>
    <button class="btn btn-md btn-kind-finished m-3"
      (click)="btnSaveCaseSourceComplete(caseFocusType.Finished)">{{ translations.CASE_COMMON.GOTO_FINISH | translate }}</button>
    <button class="btn btn-md btn-kind-finished m-3" (click)="btnSaveCaseSourceCompleteFastFinish()"
      *ngIf="businessParameter?.CanFastFinished">{{ translations.CASE_COMMON.QUICK_FINISH | translate }}</button>
  </div>
</div>
